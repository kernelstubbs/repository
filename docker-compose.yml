---
version: "3.7"

x-defaultCONF: &defaultCONF
  env_file: [./env/global.env]
x-deploySingle: &deploySingle
  replicas: 1
  update_config:
    failure_action: rollback
  placement:
      constraints: [node.role == manager]

x-driver_opts: &driverOpts
  type: nfs
  o: addr=10.10.10.252,rw,bg,intr,soft,nolock
x-nfs-driver: &nfsDriver
  driver: local

services:
#  minecraft:
#    image: itzg/minecraft-server
#    hostname: forge
#    env_file: [./env/forge.env]
#    ports:
#      - "28016:28016"
#      - "25565:25565"
#    networks: [forge-net]
#    volumes: ["forge_mc:/data"]
#  rcon:
#    image: itzg/rcon
#    ports:
#      - "4326:4326"
#     - "4327:4327"
#   networks: [forge-net]
#    volumes: ["rcon:/opt/rcon-web-admin/db"]
  traefik:
    image: traefik
    command: 
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.swarmMode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # LetsEncrypt
      - "--certificatesresolvers.CFWildcard.acme.email=${CF_API_EMAIL}"
      - "--certificatesresolvers.CFWildcard.acme.dnschallenge.provider=cloudflare"
      - "--certificatesresolvers.CFWildcard.acme.storage=/etc/traefik/acme.json"
    <<: *defaultCONF
    deploy:
      <<: *deploySingle
      labels: 
        - "traefik.enable=true"
        - "traefik.http.routers.traefik.rule=Host(`traefik.beowulf.cc`)"
        - "traefik.http.services.traefik.loadbalancer.server.port=8080"
        - "traefik.http.services.traefik.loadbalancer.server.scheme=http"
        # HTTP ==> HTTPS
        - "traefik.http.routers.http-catchall.rule=hostregexp(`{host:[a-z-.]+}`)"
        - "traefik.http.routers.http-catchall.entrypoints=web"
        - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
        # CF Wildcard
        - "traefik.http.routers.traefik.tls.domains[0].main=beowulf.cc"
        - "traefik.http.routers.traefik.tls.domains[0].sans=*.beowulf.cc"
        - "traefik.http.routers.traefik.tls.certresolver=CFWildcard"
    ports:
      - "80:80"
      - "8080:8080"
    networks:
      - torrent-net
      - radarr-net
      - sonarr-net
      - port-net
      - plex-net
      - forge-net
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - traefik_cert:/etc/traefik/traefik.json
  shepherd:
    image: mazzolino/shepherd
    deploy:
      <<: *deploySingle
    environment: [SLEEP_TIME=8h]
    volumes: ["/var/run/docker.sock:/var/run/docker.sock"]
    networks: [shepherd-net]
  plex:
    image: plexinc/pms-docker
    <<: *defaultCONF
    deploy:
      <<: *deploySingle
      labels: 
        - "traefik.enable=true"
        - "traefik.http.routers.plex.rule=Host(`plex.beowulf.cc`)"
        - "traefik.http.routers.plex.entrypoints=websecure"
        - "traefik.http.routers.plex.tls.certresolver=CFWildcard"
        - "traefik.http.services.plex.loadbalancer.server.port=32400"
        - "traefik.docker.network=homelab_plex-net"
    ports:
      - "3005:3005"
      - "8324:8324"
      - "32400:32400"
      - "32469:32469"
      - "1900:1900/udp"
      - "32410:32410/udp"
      - "32412-32414:32412-32414/udp"
    networks: [plex-net]
    volumes: 
      - plex_cfg:/config
      - plex_lib:/data
  sonarr:
    image: linuxserver/sonarr
    <<: *defaultCONF
    deploy:
      <<: *deploySingle
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.sonarr.rule=Host(`sonarr.beowulf.cc`)"
        - "traefik.http.routers.sonarr.entrypoints=websecure"
        - "traefik.http.routers.sonarr.tls.certresolver=CFWildcard"
        - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
        - "traefik.docker.network=homelab_sonarr-net"
    networks:
      - sonarr-net
      - torrent-net
      - plex-net
    volumes:
      - sonarr_cfg:/config
      - plex_tv:/tv
      - downloads:/downloads
  radarr:
    image: linuxserver/radarr
    <<: *defaultCONF
    deploy:
      <<: *deploySingle
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.radarr.rule=Host(`radarr.beowulf.cc`)"
        - "traefik.http.routers.radarr.entrypoints=websecure"
        - "traefik.http.routers.radarr.tls.certresolver=CFWildcard"
        - "traefik.http.services.radarr.loadbalancer.server.port=7878"
        - "traefik.docker.network=homelab_radarr-net"
    networks:
      - radarr-net
      - torrent-net
      - plex-net
    volumes:
      - radarr_cfg:/config
      - plex_movies:/movies
      - downloads:/downloads
  portainer:
    image: portainer/portainer
    command: -H unix:///var/run/docker.sock
    <<: *defaultCONF
    deploy:
      <<: *deploySingle
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.portainer.rule=Host(`portainer.beowulf.cc`)"
        - "traefik.http.routers.portainer.entrypoints=websecure"
        - "traefik.http.routers.portainer.tls.certresolver=CFWildcard"
        - "traefik.http.services.portainer.loadbalancer.server.port=9000"
        - "traefik.docker.network=homelab_port-net"
    networks: [port-net]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_dat:/data
  vpn:
    image: bubuntux/nordvpn
    <<: *defaultCONF
    env_file: [./env/nordvpn.env] 
    deploy:
      <<: *deploySingle
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=homelab_torrent-net"
        # deluge
        - "traefik.http.routers.deluge.rule=Host(`deluge.beowulf.cc`)"
        - "traefik.http.routers.deluge.entrypoints=websecure"
        - "traefik.http.routers.deluge.tls.certresolver=CFWildcard"
        - "traefik.http.services.deluge.loadbalancer.server.port=8112"
        # jackett
        - "traefik.http.routers.jackett.rule=Host(`jackett.beowulf.cc`)"
        - "traefik.http.routers.jackett.entrypoints=websecure"
        - "traefik.http.routers.jackett.tls.certresolver=CFWildcard"
        - "traefik.http.services.jackett.loadbalancer.server.port=9117"
        # vpn
        - "traefik.http.routers.vpn.rule=Host(`vpn.beowulf.cc`)"
        - "traefik.http.routers.vpn.entrypoints=websecure"
        - "traefik.http.routers.vpn.tls.certresolver=CFWildcard"
        - "traefik.http.services.vpn.loadbalancer.server.port=8118"
    ports:
      - "58846:58846"
      - "58946:58946"
    networks: [torrent-net]
    devices: [/dev/net/tun]
  deluge:
    image: linuxserver/deluge
    <<: *defaultCONF
    deploy:
      <<: *deploySingle
    volumes:
      - deluge_cfg:/config
      - downloads:/downloads
    network_mode: service:vpn
  jackett:
    image: linuxserver/jackett
    <<: *defaultCONF
    deploy:
      <<: *deploySingle
    volumes:
      - jackett_cfg:/config
      - tmp:/downloads
    network_mode: service:vpn

networks:
  shepherd-net:
  sonarr-net:
  radarr-net:
  torrent-net:
  port-net:
  plex-net:
  forge-net:

volumes:
  forge_mc: 
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/forge/data"
  rcon: 
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/rcon/db"
  radarr_cfg: 
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/radarr/config"
  sonarr_cfg:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/sonarr/config"
  jackett_cfg:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/jackett/config"
  deluge_cfg:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/deluge/config"
  downloads:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/downloads"
  plex_tv:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/plex/library/television"
  plex_movies:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/plex/library/movies"
  plex_lib:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/plex/library"
  plex_cfg:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/plex/config"
  tmp:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/tmp"
  portainer_dat:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/portainer/data"
  traefik_cert:
    <<: *nfsDriver
    driver_opts:
      <<: *driverOpts
      device: ":/volume1/docker/traefik/traefik.json"